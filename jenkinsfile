pipeline {
    agent any

    environment {
        ROBOT_RESULTS_DIR = "results"
        ROBOT_TESTS_DIR   = "tests"
        REMOTE_CHROME     = "http://selenium_chrome:4444/wd/hub"
        REMOTE_FIREFOX    = "http://selenium_firefox:4445/wd/hub"
        VENV_BIN          = "/opt/venv/bin"
    }

    stages {
        stage('Install dependencies') {
            steps {
                sh '''
                ${VENV_BIN}/pip install -U robotframework robotframework-seleniumlibrary
                '''
            }
        }

        stage('Run Robot Tests - Chrome') {
            steps {
                sh '''
                mkdir -p ${ROBOT_RESULTS_DIR}/chrome
                ${VENV_BIN}/robot -d ${ROBOT_RESULTS_DIR}/chrome \
                    --variable REMOTE_URL:${REMOTE_CHROME} \
                    ${ROBOT_TESTS_DIR}
                '''
            }
        }

        stage('Run Robot Tests - Firefox') {
            steps {
                sh '''
                mkdir -p ${ROBOT_RESULTS_DIR}/firefox
                ${VENV_BIN}/robot -d ${ROBOT_RESULTS_DIR}/firefox \
                    --variable REMOTE_URL:${REMOTE_FIREFOX} \
                    ${ROBOT_TESTS_DIR}
                '''
            }
        }

        stage('Publish Robot Reports') {
            steps {
                publishRobotFrameworkReports(
                    outputPath: "${ROBOT_RESULTS_DIR}/chrome",
                    outputFileName: "output.xml"
                )
                publishRobotFrameworkReports(
                    outputPath: "${ROBOT_RESULTS_DIR}/firefox",
                    outputFileName: "output.xml"
                )
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: "${ROBOT_RESULTS_DIR}/**/*", fingerprint: true
        }
    }
}
